{% extends "base.html" %}
{% block content %}
<div class="container-fluid p-3">
  <h3>üìπ Capture Attendance</h3>
  <div class="row">
    <div class="col-md-8">
      <div class="card shadow-sm mb-3">
        <div class="card-header bg-success text-white">
          <h6 class="mb-0"><i class="fas fa-video me-2"></i>Live Camera - Scanning...</h6>
        </div>
        <div class="card-body p-0">
          <video id="attVideo" width="100%" height="400" autoplay muted playsinline></video>
        </div>
      </div>
    </div>
    
    <div class="col-md-4">
      <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
          <h6 class="mb-0">
            <i class="fas fa-list me-2"></i>Attendance Status
          </h6>
        </div>
        <div class="card-body p-3" id="statusContainer">
          <div class="text-center text-muted py-4">
            <i class="fas fa-search fa-2x mb-2 d-block"></i>
            <p class="mb-0">Scanning for faces...</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
let attStream = null;
const attVideo = document.getElementById("attVideo");
const statusContainer = document.getElementById("statusContainer");

(async () => {
  try {
    attStream = await navigator.mediaDevices.getUserMedia({ 
      video: { 
        width: { ideal: 640 },
        height: { ideal: 480 }
      } 
    });
    attVideo.srcObject = attStream;
    attVideo.addEventListener('loadedmetadata', startScanning);
  } catch (err) {
    statusContainer.innerHTML = `
      <div class="alert alert-danger">
        <i class="fas fa-camera me-2"></i>
        Camera access denied. Please allow camera permission.
      </div>
    `;
  }
})();

function startScanning() {
  // Start scanning every 2 seconds
  setInterval(scanFrame, 2000);
}

async function scanFrame() {
  if (!attVideo || attVideo.readyState !== 4) return;
  
  const canvas = document.createElement("canvas");
  canvas.width = attVideo.videoWidth;
  canvas.height = attVideo.videoHeight;
  const ctx = canvas.getContext("2d");
  ctx.drawImage(attVideo, 0, 0);
  const dataUrl = canvas.toDataURL("image/jpeg", 0.8);

  try {
    const res = await fetch("/api/mark_attendance", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({frame: dataUrl})
    });
    
    const data = await res.json();
    
    if (data.ok) {
      // ‚úÖ NEW markings - Green success
      if (data.marked && data.marked.length > 0) {
        data.marked.forEach(student => {
          addStatus(student, "success", "‚úÖ NEW", "Attendance marked!");
        });
      }
      
      // ‚ÑπÔ∏è Already marked - Yellow info
      if (data.already_marked && data.already_marked.length > 0) {
        data.already_marked.forEach(student => {
          addStatus(student, "warning", "‚ÑπÔ∏è ALREADY", "Already marked today");
        });
      }
      
      // No faces detected - quiet scanning
      if (!data.marked?.length && !data.already_marked?.length) {
        updateScanningStatus();
      }
    }
  } catch (error) {
    console.error('Scan error:', error);
  }
}

function addStatus(student, type, icon, message) {
  const statusDiv = document.createElement("div");
  statusDiv.className = `alert alert-${type} alert-dismissible fade show mb-2 py-2 px-3`;
  statusDiv.innerHTML = `
    <div class="d-flex align-items-center">
      <strong class="me-2">${icon}</strong>
      <div>
        <div class="fw-bold">${student.name}</div>
        <small class="text-muted">${student.student_id}</small>
      </div>
      <button type="button" class="btn-close btn-close-sm ms-auto" data-bs-dismiss="alert"></button>
    </div>
    <div class="mt-1 small">${message}</div>
  `;
  
  // Add to top of container
  statusContainer.insertBefore(statusDiv, statusContainer.firstChild);
  
  // Auto-remove after 10 seconds
  setTimeout(() => {
    if (statusDiv.parentNode) {
      statusDiv.remove();
    }
  }, 10000);
}

function updateScanningStatus() {
  if (!statusContainer.querySelector('.scanning-status')) {
    const scanningDiv = document.createElement("div");
    scanningDiv.className = "text-center text-muted py-3 scanning-status";
    scanningDiv.innerHTML = `
      <i class="fas fa-circle-notch fa-spin fa-lg mb-2 d-block"></i>
      <small>Scanning for faces... (every 2 seconds)</small>
    `;
    statusContainer.innerHTML = '';
    statusContainer.appendChild(scanningDiv);
  }
}
</script>
{% endblock %}
